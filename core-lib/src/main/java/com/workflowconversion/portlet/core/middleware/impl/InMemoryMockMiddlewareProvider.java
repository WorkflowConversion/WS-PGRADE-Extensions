package com.workflowconversion.portlet.core.middleware.impl;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.Collection;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.Unmarshaller;

import com.workflowconversion.portlet.core.exception.ApplicationException;

import dci.data.Configure;
import dci.data.Middleware;

/**
 * In-memory mock middleware provider (for testing purposes).
 * 
 * @author delagarza
 *
 */
public class InMemoryMockMiddlewareProvider extends AbstractFilteredMiddlewareProvider {

	private static final long serialVersionUID = 770998780205006667L;
	private final Configure configure;

	/**
	 * Constructor.
	 */
	public InMemoryMockMiddlewareProvider() {
		try {
			final JAXBContext jc = JAXBContext.newInstance("dci.data");
			final Unmarshaller u = jc.createUnmarshaller();
			configure = (Configure) u.unmarshal(getXml());
		} catch (Exception e) {
			throw new ApplicationException("Could not instantiate InMemoryMockMiddlewareProvider!!!", e);
		}
	}

	private InputStream getXml() {
		final String content = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?> <configure xmlns=\"data.dci\">     <middlewares>         <middleware type=\"broker\" enabled=\"true\">             <item name=\"RPS\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_broker</plugin>             <threads>1</threads>             <disrescont>false</disrescont>             <resubmit>0</resubmit>         </middleware>         <middleware type=\"cloud\" enabled=\"true\">             <item name=\"LPDS cloud\" enabled=\"true\">                 <forward usethis=\"false\">                     <cloud>                         <url>http://cfe2.lpds.sztaki.hu:4567</url>                         <image>ami-001250</image>                         <quota>20</quota>                     </cloud>                 </forward>             </item>             <item name=\"SZTAKI cloud\" enabled=\"true\">                 <forward usethis=\"false\">                     <cloud>                         <url>http://vh-frontend-1.felho.sztaki.hu:4567</url>                         <image>ami-000727</image>                         <quota>30</quota>                     </cloud>                 </forward>             </item>             <item name=\"LPDS OCCI\" enabled=\"true\">                 <forward usethis=\"true\">                     <occi>                         <url>https://occi.hpcc.sztaki.hu:3202/</url>                         <template>os_tpl#uuid_app_dci_bridge_localcloud_v10_636</template>                         <quota>5</quota>                         <size>resource_tpl#small</size>                         <vo>fedcloud.egi.eu</vo>                     </occi>                 </forward>             </item>             <item name=\"SZTAKI cloud\" enabled=\"true\">                 <forward usethis=\"false\">                     <cloud>                         <url>http://vh-frontend-1.felho.sztaki.hu:4567</url>                         <image>ami-000497</image>                         <quota>5</quota>                     </cloud>                 </forward>             </item>             <certificate>x509 RFC</certificate>             <certificate>Basic authentication</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_local</plugin>             <threads>5</threads>             <disrescont>false</disrescont>             <resubmit>3</resubmit>             <iohandler>1</iohandler>         </middleware>         <middleware type=\"local\" enabled=\"true\">             <item name=\"dci-bridge host(64bit)\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_local</plugin>             <threads>5</threads>             <disrescont>false</disrescont>             <resubmit>3</resubmit>             <iohandler>1</iohandler>         </middleware>         <middleware type=\"dirac\" enabled=\"true\">             <item name=\"dirac.egi.eu\" enabled=\"true\">                 <dirac>                     <group>hungrid_user</group>                     <setup>EGI-Production</setup>                     <url>https://dirac4.grid.cyfronet.pl:9178</url>                 </dirac>                 <forward usethis=\"true\"/>             </item>             <certificate>Dirac token</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_dirac</plugin>             <threads>1</threads>             <disrescont>false</disrescont>             <resubmit>0</resubmit>         </middleware>         <middleware type=\"glite\" enabled=\"true\">             <item name=\"voce\" enabled=\"true\">                 <glite>                     <accessdata>bdii.cyf-kr.edu.pl:2170:mds-vo-name=local,o=grid</accessdata>                     <type>LDAP_BDII</type>                     <bdii>bdii.cyf-kr.edu.pl:2170</bdii>                     <wms>https://wms.ui.savba.sk:7443/glite_wms_wmproxy_server</wms>                     <lfc>skurut2.cesnet.cz</lfc>                     <statuswait>0</statuswait>                     <disablehost>0</disablehost>                 </glite>                 <forward usethis=\"true\"/>             </item>             <item name=\"seegrid\" enabled=\"true\">                 <glite>                     <accessdata>bdii.ipb.ac.rs:2170:mds-vo-name=local,o=grid</accessdata>                     <type>LDAP_BDII</type>                     <bdii>bdii.ipb.ac.rs:2170</bdii>                     <wms>https://wms.ipb.ac.rs:7443/glite_wms_wmproxy_server</wms>                     <lfc>grid02.rcub.bg.ac.rs</lfc>                     <statuswait>0</statuswait>                     <disablehost>0</disablehost>                 </glite>                 <forward usethis=\"true\"/>                 <iohandlervo>1</iohandlervo>                 <dahandlervo>1</dahandlervo>             </item>             <item name=\"gilda\" enabled=\"true\">                 <glite>                     <accessdata>gilda-bdii.ct.infn.it:2170:mds-vo-name=local,o=grid</accessdata>                     <type>LDAP_BDII</type>                     <bdii>gilda-bdii.ct.infn.it:2170</bdii>                     <wms>https://gilda-wms-01.ct.infn.it:7443/glite_wms_wmproxy_server</wms>                     <lfc>lfc-gilda.ct.infn.it</lfc>                     <statuswait>0</statuswait>                     <disablehost>0</disablehost>                 </glite>                 <forward usethis=\"true\"/>             </item>             <item name=\"hungrid\" enabled=\"true\">                 <glite>                     <accessdata>grid152.kfki.hu:2170:mds-vo-name=local,o=grid</accessdata>                     <type>LDAP_BDII</type>                     <bdii>grid152.kfki.hu:2170</bdii>                     <wms>https://grid150.kfki.hu:7443/glite_wms_wmproxy_server</wms>                     <lfc>grid155.kfki.hu</lfc>                     <statuswait>0</statuswait>                     <disablehost>0</disablehost>                 </glite>                 <forward usethis=\"true\"/>             </item>             <certificate>x509 GSI</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_glite</plugin>             <threads>5</threads>             <disrescont>false</disrescont>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"boinc\" enabled=\"false\">             <item name=\"edgidemo\" enabled=\"true\">                 <boinc>                     <wsdl>http://www.guse.hu/storage/wsdl/3gbridge/mishra.lpds.sztaki.hu.wsdl</wsdl>                     <id>edgidemo</id>                 </boinc>                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_boinc</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"gbac\" enabled=\"false\">             <item name=\"GBAC-TEST\" enabled=\"true\">                 <gbac>                     <wsdl>http://www.guse.hu/storage/wsdl/3gbridge/kanuka.lpds.sztaki.hu.wsdl</wsdl>                     <id>DG</id>                     <rundescurl>http://guse.hu/storage/data/gbac.xml</rundescurl>                 </gbac>                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gbac</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"cloudbridge\" enabled=\"false\">             <item name=\"SZTAKI Cloud\" enabled=\"true\">                 <cloudbridge>                     <wsdl>http://c176.cloud/3GBridgeSubmitter.wsdl</wsdl>                     <id>condor</id>                 </cloudbridge>                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_cloudbridge</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"gt2\" enabled=\"false\">             <item name=\"seegridgt2\" enabled=\"false\">                 <gt2>                     <resource host=\"ce01.afroditi.hellasgrid.gr\">                         <jobmanager>jobmanager-pbs-seegrid</jobmanager>                     </resource>                     <resource host=\"c01.grid.etfbl.net\">                         <jobmanager>jobmanager-pbs-seegrid</jobmanager>                     </resource>                     <accessdata>bdii.ipb.ac.rs:2170:mds-vo-name=local,o=grid</accessdata>                     <type>ldap-BDII</type>                 </gt2>                 <forward usethis=\"true\"/>             </item>             <certificate>x509 GSI</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gt5</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"gt4\" enabled=\"false\">             <item name=\"WestFocus\" enabled=\"true\">                 <gt4>                     <type>LDAP_BDII</type>                     <accessdata>bdii.ngs.ac.uk:2170:mds-vo-name=local,o=grid</accessdata>                     <resource host=\"ngs.wmin.ac.uk\">                         <jobmanager>jobmanager-pbs</jobmanager>                     </resource>                 </gt4>                 <forward usethis=\"true\"/>             </item>             <certificate>x509 GSI</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gt5</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"gt5\" enabled=\"false\">             <item name=\"gt5grid\" enabled=\"true\">                 <gt5>                     <type>LDAP_BDII</type>                     <accessdata>bdii.gt-ige.utcluj.ro:2170:mds-vo-name=local,o=grid</accessdata>                     <resource host=\"ngs.wmin.ac.uk\">                         <jobmanager>jobmanager-pbs</jobmanager>                     </resource>                     <resource host=\"gt-ige.utcluj.ro\">                         <jobmanager>jobmanager-pbs</jobmanager>                     </resource>                     <resource host=\"ngs.wmin.ac.uk\">                         <jobmanager>jobmanager-pbs</jobmanager>                     </resource>                 </gt5>                 <forward usethis=\"true\"/>                 <iohandlervo>1</iohandlervo>             </item>             <certificate>x509 GSI</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gt5</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"service\" enabled=\"false\">             <item name=\"axis\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_service</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"pbs\" enabled=\"true\">             <item name=\"c153-110.localcloud\" enabled=\"true\">                 <pbs>                     <queue>batch</queue>                 </pbs>                 <forward usethis=\"true\"/>             </item>             <certificate>ssh key</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_pbs</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"sge\" enabled=\"false\">             <item name=\"tannat.srce.hr\" enabled=\"true\">                 <sge>                     <queue>all.q</queue>                     <queue>gpu.q</queue>                 </sge>                 <forward usethis=\"true\"/>             </item>             <certificate>ssh key</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_sge</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"arc\" enabled=\"false\">             <item name=\"NIIF\" enabled=\"true\">                 <arc>                     <accessdata>grid.uio.no:2135:mds-vo-name=Norway,o=grid</accessdata>                     <type>LDAP_ARC</type>                     <configpath>/home/projects/guse/.arc/client.conf</configpath>                 </arc>                 <forward usethis=\"true\"/>             </item>             <certificate>x509 RFC</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_arc</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"shiwa\" enabled=\"false\">             <item name=\"Submission-Service-Westminster\" enabled=\"true\">                 <gelmca>                     <submissionserviceurl>https://submission.cpc.wmin.ac.uk/SubmissionService/</submissionserviceurl>                     <defaultshiwarepo>https://shiwa-repo.cpc.wmin.ac.uk/shiwa-repo/</defaultshiwarepo>                 </gelmca>                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_shiwa</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"gae\" enabled=\"false\">             <item name=\"google\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gae</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"rest\" enabled=\"false\">             <item name=\"rest\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gae</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"http\" enabled=\"false\">             <item name=\"http\" enabled=\"true\">                 <forward usethis=\"true\"/>             </item>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_gae</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"lsf\" enabled=\"false\">             <item name=\"lsf.test.sztaki.hu\" enabled=\"true\">                 <lsf>                     <queue>long</queue>                     <queue>short</queue>                 </lsf>                 <forward usethis=\"true\"/>             </item>             <certificate>ssh key</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_lsf</plugin>             <threads>5</threads>             <resubmit>1</resubmit>         </middleware>         <middleware type=\"moab\" enabled=\"true\">             <item name=\"fake-cluster.uni.edu\" enabled=\"true\">                 <moab>                     <cacheExpiration>10000</cacheExpiration>                     <serializeMoabAccess>true</serializeMoabAccess>                     <maxRetries>10</maxRetries>                     <waitLowerBound>1500</waitLowerBound>                     <waitWindowSize>6500</waitWindowSize>                     <queue>hpc-uni</queue>                 </moab>                 <forward usethis=\"true\"/>             </item>             <item name=\"bogus.uni.edu\" enabled=\"true\">                 <moab>                     <cacheExpiration>15000</cacheExpiration>                     <serializeMoabAccess>false</serializeMoabAccess>                     <maxRetries>15</maxRetries>                     <waitLowerBound>1580</waitLowerBound>                     <waitWindowSize>6500</waitWindowSize>                     <queue>hohohoho</queue>                 </moab>                 <forward usethis=\"true\"/>             </item>             <certificate>ssh key</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_moab</plugin>             <threads>1</threads>         </middleware>         <middleware type=\"unicore\" enabled=\"true\">             <item name=\"unicore.fake.org:8080\" enabled=\"true\">                 <unicore>                     <keystore>keystore.p12</keystore>                     <keypass>pass</keypass>                     <keyalias>hoho</keyalias>                     <subjectdn></subjectdn>                     <truststore>booh.jks</truststore>                     <trustpass>pass</trustpass>                 </unicore>                 <forward usethis=\"false\">                     <wsdl/>                 </forward>             </item>             <item name=\"uni-core.com:8090\" enabled=\"true\">                 <unicore>                     <keystore>cert.p12</keystore>                     <keypass>pass</keypass>                     <keyalias>alis</keyalias>                     <subjectdn>buah</subjectdn>                     <truststore>store.jks</truststore>                     <trustpass>pass</trustpass>                 </unicore>                 <forward usethis=\"true\"/>             </item>             <certificate>saml</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_unicore</plugin>             <threads>1</threads>             <disrescont>false</disrescont>             <resubmit>0</resubmit>         </middleware>         <middleware type=\"edgi\" enabled=\"false\">             <item name=\"Prod-AR\" enabled=\"true\">                 <edgi>                     <url>http://edgi-repo.cpc.wmin.ac.uk/repository/</url>                 </edgi>                 <forward usethis=\"true\"/>             </item>             <certificate>x509 GSI</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_edgi</plugin>             <threads>5</threads>         </middleware>         <middleware type=\"cloudbroker\" enabled=\"false\">             <item name=\"platform\" enabled=\"true\">                 <cloudbroker>                     <url>https://platform.cloudbroker.com</url>                     <userManagement>individual</userManagement>                     <displayCosts>false</displayCosts>                     <ownExeExecutable>c75db6fa-d6eb-47e3-a970-630778204b31</ownExeExecutable>                 </cloudbroker>                 <forward usethis=\"true\"/>             </item>             <item name=\"scibus\" enabled=\"true\">                 <cloudbroker>                     <url>https://scibus.cloudbroker.com</url>                     <userManagement>individual</userManagement>                     <displayCosts>false</displayCosts>                 </cloudbroker>                 <forward usethis=\"true\"/>             </item>             <certificate>Basic authentication</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_cloudbroker</plugin>             <threads>5</threads>             <resubmit>0</resubmit>         </middleware>         <middleware type=\"xsede\" enabled=\"false\">             <item name=\"xcg.virginia.edu-xcg3\" enabled=\"false\">                 <xsede>                     <queue>/resources/xcg.virginia.edu/queues/grid-queue-xcg3</queue>                 </xsede>                 <forward usethis=\"true\"/>                 <iohandlervo>2</iohandlervo>                 <dahandlervo>1</dahandlervo>             </item>             <certificate>Basic authentication path</certificate>             <plugin>hu.sztaki.lpds.submitter.grids.Grid_xsede</plugin>             <threads>1</threads>             <disrescont>false</disrescont>             <resubmit>0</resubmit>         </middleware>     </middlewares>     <properties>         <debug>0</debug>         <java></java>         <callbackurl></callbackurl>     </properties>     <system>         <dataavenuebt>https://data-avenue.eu/blacktop2/</dataavenuebt>     </system> </configure>";
		final InputStream inputStream = new ByteArrayInputStream(content.getBytes(StandardCharsets.UTF_8));
		return inputStream;
	}

	@Override
	public Collection<Middleware> getAllMiddlewares() {
		return configure.getMiddlewares().getMiddleware();
	}

}
